<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–Ñ–¥–∏–Ω–∏–π –†–µ—î—Å—Ç—Ä –î–æ—Å—É–¥–æ–≤–∏—Ö –†–æ–∑—Å–ª—ñ–¥—É–≤–∞–Ω—å</title>
  <style>
    :root{font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;}
    body{max-width:1100px;margin:24px auto;padding:16px}
    h1{font-size:20px;margin-bottom:8px}
    form{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:18px}
    label{display:flex;flex-direction:column;font-size:13px}
    input, textarea, select{padding:8px;border:1px solid #bbb;border-radius:6px;font-size:14px}
    textarea{resize:vertical;min-height:72px}
    .full{grid-column:1/-1}
    .controls{display:flex;gap:8px;align-items:center}
    button{padding:8px 12px;border:0;border-radius:6px;cursor:pointer}
    button.save{background:#2b6cb0;color:white}
    button.clear{background:#e2e8f0}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border:1px solid #e6e6e6;text-align:left;font-size:13px}
    .actions button{margin-right:6px}
    .small{font-size:12px;color:#555}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    input[type=file]{display:none}
    /* login screen */
    #loginScreen{position:fixed;inset:0;background:rgba(10,10,10,0.85);display:flex;align-items:center;justify-content:center;z-index:9999;}
    #loginScreen div{background:white;padding:24px;border-radius:12px;width:360px;text-align:center;font-family:sans-serif;box-shadow:0 6px 30px rgba(0,0,0,0.2);}
    #loginScreen input{width:100%;padding:10px;margin-bottom:10px;box-sizing:border-box;}
    #loginScreen button{padding:10px 20px;width:100%;cursor:pointer;}
    #loginError{color:red;margin-top:10px;display:none;}
  </style>
</head>
<body>

<!-- ===== LOGIN WINDOW ===== -->
<div id="loginScreen">
  <div>
    <h2>üîê –í—Ö—ñ–¥</h2>
    <input id="loginInput" placeholder="–õ–æ–≥—ñ–Ω">
    <input id="passInput" placeholder="–ü–∞—Ä–æ–ª—å" type="password">
    <button id="loginBtn">–£–≤—ñ–π—Ç–∏</button>
    <p id="loginError">‚ùå –ù–µ–≤—ñ—Ä–Ω—ñ –¥–∞–Ω—ñ</p>
  </div>
</div>

<h1>–Ñ–¥–∏–Ω–∏–π –†–µ—î—Å—Ç—Ä –î–æ—Å—É–¥–æ–≤–∏—Ö –†–æ–∑—Å–ª—ñ–¥—É–≤–∞–Ω—å</h1>
<p class="small">–ó–±–µ—Ä—ñ–≥–∞—î –¥–∞–Ω—ñ –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ. –ú–æ–∂–Ω–∞ –µ–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏/—ñ–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ JSON –∞–±–æ CSV, –¥–æ–¥–∞–≤–∞—Ç–∏ —Ñ–∞–π–ª–∏.</p>

<form id="caseForm">
  <label>–ù–æ–º–µ—Ä —Å–ø—Ä–∞–≤–∏ <input name="caseNumber" required></label>
  <label>–°—Ç–∞—Ç—É—Å
    <select name="status">
      <option value="–í—ñ–¥–∫—Ä–∏—Ç–∞">–í—ñ–¥–∫—Ä–∏—Ç–∞</option>
      <option value="–ó–∞–∫—Ä–∏—Ç–∞">–ó–∞–∫—Ä–∏—Ç–∞</option>
      <option value="–ü—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–∞">–ü—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–∞</option>
    </select>
  </label>
  <label>–Ü–Ω—ñ—Ü—ñ–∞—Ç–æ—Ä <input name="initiator"></label>
  <label>–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π —Å–ª—ñ–¥—á–∏–π <input name="investigator"></label>
  <label>–î–∞—Ç–∞ –≤–Ω–µ—Å–µ–Ω–Ω—è <input type="date" name="date"></label>
  <label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è <input name="category"></label>
  <label class="full">–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å <textarea name="description"></textarea></label>
  <div class="full controls">
    <button type="submit" class="save">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–∞–ø–∏—Å</button>
    <button type="button" class="clear" id="resetForm">–û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É</button>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <button id="exportJsonBtn" type="button">–ï–∫—Å–ø–æ—Ä—Ç JSON</button>
      <button id="exportCsvBtn" type="button">–ï–∫—Å–ø–æ—Ä—Ç CSV</button>
      <label for="importFile" style="cursor:pointer;padding:8px;border-radius:6px;border:1px dashed #bbb">–Ü–º–ø–æ—Ä—Ç JSON</label>
      <input id="importFile" type="file" accept="application/json">
      <button id="clearAll" type="button" title="–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –∑–∞–ø–∏—Å–∏">–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –∑–∞–ø–∏—Å–∏</button>
    </div>
  </div>
</form>

<div class="toolbar">
  <input id="search" placeholder="–ü–æ—à—É–∫ –ø–æ –Ω–æ–º–µ—Ä—É, —Å–ª—ñ–¥—á–æ–º—É, –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó...">
  <select id="filterStatus">
    <option value="">–£—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option>
    <option value="–í—ñ–¥–∫—Ä–∏—Ç–∞">–í—ñ–¥–∫—Ä–∏—Ç–∞</option>
    <option value="–ó–∞–∫—Ä–∏—Ç–∞">–ó–∞–∫—Ä–∏—Ç–∞</option>
    <option value="–ü—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–∞">–ü—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–∞</option>
  </select>
  <button id="newCase" type="button">–ù–æ–≤–∏–π –∑–∞–ø–∏—Å (—à–≤–∏–¥–∫–∏–π)</button>
</div>

<table id="casesTable">
  <thead>
    <tr><th>–ù–æ–º–µ—Ä</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ï—Ç–∞–ø</th><th>–Ü–Ω—ñ—Ü—ñ–∞—Ç–æ—Ä</th><th>–°–ª—ñ–¥—á–∏–π</th><th>–î–∞—Ç–∞</th><th>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th><th>–û–ø–∏—Å</th><th>–§–∞–π–ª–∏</th><th>–î—ñ—ó</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
document.addEventListener('DOMContentLoaded', ()=>{

  // CONFIG
  const STORAGE_KEY = 'erd_r_entries_v1';
  const CREDENTIALS = { Police: '7458he45hksa43' };

  // STATE
  let entries = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  const form = document.getElementById('caseForm');
  const tbody = document.querySelector('#casesTable tbody');
  const searchInput = document.getElementById('search');
  const filterStatus = document.getElementById('filterStatus');

  // STAGES
  const stageList = ["–ó–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ","–†–æ–∑—Å–ª—ñ–¥—É—î—Ç—å—Å—è","–ü–µ—Ä–µ–¥–∞–Ω–æ –¥–æ —Å—É–¥—É","–ó–∞–∫—Ä–∏—Ç–æ"];
  const stageSelect = document.createElement('select'); stageSelect.name='stage';
  stageList.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; stageSelect.appendChild(o); });
  form.querySelector('label.full').insertAdjacentElement('beforebegin', stageSelect);

  // FILES
  const fileInput = document.createElement('input'); fileInput.type='file'; fileInput.multiple=true; fileInput.name='files';
  form.appendChild(fileInput);

  // HELPERS
  function uid(){return Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,8);}
  function saveEntries(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }
  function escapeHTML(s){ return String(s||'').replace(/[&<>\"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  function escapeCSVCell(s){ if(s==null) return '""'; s=String(s).replace(/"/g,'""'); return '"'+s+'"'; }

  async function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const fr = new FileReader(); fr.onload=()=>res({name:file.name,type:file.type,data:fr.result}); fr.onerror=()=>rej(fr.error); fr.readAsDataURL(file); }); }
  async function encodeFiles(files){ const arr=[]; for(const f of files) arr.push(await readFileAsDataURL(f)); return arr; }

  // RENDER
  function render(){
    const q = (searchInput.value||'').toLowerCase();
    const status = filterStatus.value;
    tbody.innerHTML='';
    const filtered = entries.filter(e=>{
      if(status && e.status!==status) return false;
      if(!q) return true;
      return [e.caseNumber,e.initiator,e.investigator,e.category,e.description].some(v=>(v||'').toLowerCase().includes(q));
    });
    if(filtered.length===0){ const tr=document.createElement('tr'); tr.innerHTML='<td colspan="10" class="small">–ó–∞–ø–∏—Å—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</td>'; tbody.appendChild(tr); return; }
    filtered.forEach(e=>{
      const tr=document.createElement('tr');
      const filesCount = (e.files&&e.files.length)? e.files.length:0;
      tr.innerHTML=`<td>${escapeHTML(e.caseNumber)}</td>
        <td>${escapeHTML(e.status)}</td>
        <td>${escapeHTML(e.stage||'')}</td>
        <td>${escapeHTML(e.initiator||'')}</td>
        <td>${escapeHTML(e.investigator||'')}</td>
        <td>${escapeHTML(e.date||'')}</td>
        <td>${escapeHTML(e.category||'')}</td>
        <td>${escapeHTML(e.description||'')}</td>
        <td>${filesCount}</td>
        <td class="actions">
          <button data-id="${e.id}" class="edit">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
          <button data-id="${e.id}" class="delete">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function autoNumber(){
    let max=0; entries.forEach(e=>{ const n=parseInt(String(e.caseNumber).replace(/\D+/g,'')); if(!isNaN(n)) max=Math.max(max,n); });
    if(form && form.elements && form.elements.caseNumber) form.elements.caseNumber.value=String(max+1);
  }

  // FORM SUBMIT
  form.addEventListener('submit', async e=>{
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    if(!data.caseNumber){ alert('–í–∫–∞–∂—ñ—Ç—å –Ω–æ–º–µ—Ä —Å–ø—Ä–∞–≤–∏'); return; }
    let attached = []; if(fileInput.files.length>0) attached = await encodeFiles(fileInput.files);
    data.files = attached;
    if(data.id){
      const idx = entries.findIndex(x=>x.id===data.id);
      if(idx>=0){ entries[idx]={...entries[idx],...data}; saveEntries(); render(); form.reset(); fileInput.value=''; const idEl=form.querySelector('[name="id"]'); if(idEl) idEl.remove(); autoNumber(); return; }
    }
    const item={id:uid(),caseNumber:data.caseNumber,status:data.status||'',stage:data.stage||'',initiator:data.initiator||'',investigator:data.investigator||'',date:data.date||'',category:data.category||'',description:data.description||'',files:data.files||[],createdAt:new Date().toISOString()};
    entries.unshift(item); saveEntries(); render(); form.reset(); fileInput.value=''; autoNumber();
  });

  document.getElementById('resetForm').addEventListener('click', ()=>{ form.reset(); fileInput.value=''; autoNumber(); });

  tbody.addEventListener('click', e=>{
    if(e.target.matches('button.edit')){
      const id=e.target.dataset.id;
      const entry=entries.find(x=>x.id===id); if(!entry) return;
      let idInput=form.querySelector('[name="id"]'); if(!idInput){ idInput=document.createElement('input'); idInput.type='hidden'; idInput.name='id'; form.appendChild(idInput);}
      idInput.value=entry.id;
      form.elements.caseNumber.value=entry.caseNumber;
      form.elements.status.value=entry.status;
      form.elements.stage.value=entry.stage||stageList[0];
      form.elements.initiator.value=entry.initiator;
      form.elements.investigator.value=entry.investigator;
      form.elements.date.value=entry.date;
      form.elements.category.value=entry.category;
      form.elements.description.value=entry.description;
      window.scrollTo({top:0,behavior:'smooth'});
    }
    if(e.target.matches('button.delete')){
      const id=e.target.dataset.id; if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Å?')) return;
      entries=entries.filter(x=>x.id!==id); saveEntries(); render();
    }
  });

  // EXPORT
  document.getElementById('exportJsonBtn').addEventListener('click', ()=>{
    const blob=new Blob([JSON.stringify(entries,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='erd_r_export_'+(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')+'.json'; document.body.appendChild(a); a.click(); a.remove();
  });

  document.getElementById('exportCsvBtn').addEventListener('click', ()=>{
    const header=['–ù–æ–º–µ—Ä','–°—Ç–∞—Ç—É—Å','–ï—Ç–∞–ø','–Ü–Ω—ñ—Ü—ñ–∞—Ç–æ—Ä','–°–ª—ñ–¥—á–∏–π','–î–∞—Ç–∞','–ö–∞—Ç–µ–≥–æ—Ä—ñ—è','–û–ø–∏—Å','–§–∞–π–ª–∏'];
    const rows=[header.map(escapeCSVCell).join(';')];
    entries.forEach(e=>{
      const filesList=(e.files||[]).map(f=>f.name).join(',');
      const row=[e.caseNumber,e.status,e.stage,e.initiator,e.investigator,e.date,e.category,e.description,filesList].map(escapeCSVCell).join(';');
      rows.push(row);
    });
    const csv=rows.join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const link=document.createElement('a'); link.href=URL.createObjectURL(blob); link.download='erd_r_export_'+(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')+'.csv'; document.body.appendChild(link); link.click(); link.remove();
  });

  // IMPORT JSON
  document.getElementById('importFile').addEventListener('change', async e=>{
    const f=e.target.files[0]; if(!f) return;
    try{
      const txt=await f.text(); const data=JSON.parse(txt); if(!Array.isArray(data)) return alert('–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç JSON ‚Äî –æ—á—ñ–∫—É—î—Ç—å—Å—è –º–∞—Å–∏–≤ –∑–∞–ø–∏—Å—ñ–≤');
      const existingIds=new Set(entries.map(x=>x.id));
      const toAdd=data.filter(x=>x && x.caseNumber && !existingIds.has(x.id)).map(x=>({...x,id:x.id||uid()}));
      entries=toAdd.concat(entries); saveEntries(); render(); alert('–Ü–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ '+toAdd.length+' –∑–∞–ø–∏—Å—ñ–≤');
    }catch(err){ alert('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É: '+err.message);}
    e.target.value='';
  });

  document.getElementById('clearAll').addEventListener('click', ()=>{
    if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –ª–æ–∫–∞–ª—å–Ω—ñ –∑–∞–ø–∏—Å–∏? –¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ –≤—ñ–¥–º—ñ–Ω–∏—Ç–∏.')) return;
    entries=[]; saveEntries(); render();
  });

  searchInput.addEventListener('input', render);
  filterStatus.addEventListener('change', render);
  document.getElementById('newCase').addEventListener('click', ()=>{ form.reset(); fileInput.value=''; form.elements.caseNumber.focus(); autoNumber(); });

  // --------- LOGIN ---------
  const loginScreen = document.getElementById('loginScreen');
  const loginInput = document.getElementById('loginInput');
  const passInput = document.getElementById('passInput');
  const loginBtn = document.getElementById('loginBtn');
  const loginError = document.getElementById('loginError');

  function showLogin(show){ loginScreen.style.display = show ? 'flex' : 'none'; }

  function doLogin(){
    const L = loginInput.value; const P = passInput.value;
    if(CREDENTIALS[L] === P){ localStorage.setItem('erd_logged','1'); loginError.style.display='none'; showLogin(false); } 
    else{ loginError.style.display='block'; }
  }

  loginBtn.addEventListener('click', doLogin);
  [loginInput, passInput].forEach(inp=>inp.addEventListener('keyup', e=>{ if(e.key==='Enter') doLogin(); }));

  if(!localStorage.getItem('erd_logged')) showLogin(true); else showLogin(false);

  // INITIAL
  autoNumber(); render();
});
</script>
</body>
</html>
